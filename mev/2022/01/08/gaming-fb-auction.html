<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Lessons Learned from Trying to Game the Flashbots Auction | ghilia</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Lessons Learned from Trying to Game the Flashbots Auction" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Trying to game the Flashbots auction." />
<meta property="og:description" content="Trying to game the Flashbots auction." />
<link rel="canonical" href="https://ghiliweld.github.io/blog/mev/2022/01/08/gaming-fb-auction.html" />
<meta property="og:url" content="https://ghiliweld.github.io/blog/mev/2022/01/08/gaming-fb-auction.html" />
<meta property="og:site_name" content="ghilia" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-08T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lessons Learned from Trying to Game the Flashbots Auction" />
<script type="application/ld+json">
{"headline":"Lessons Learned from Trying to Game the Flashbots Auction","url":"https://ghiliweld.github.io/blog/mev/2022/01/08/gaming-fb-auction.html","dateModified":"2022-01-08T00:00:00-06:00","datePublished":"2022-01-08T00:00:00-06:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ghiliweld.github.io/blog/mev/2022/01/08/gaming-fb-auction.html"},"description":"Trying to game the Flashbots auction.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://ghiliweld.github.io/blog/feed.xml" title="ghilia" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">ghilia</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Lessons Learned from Trying to Game the Flashbots Auction</h1><p class="page-description">Trying to game the Flashbots auction.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-08T00:00:00-06:00" itemprop="datePublished">
        Jan 8, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#mev">mev</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>After following the MEV space for a while, I wanted to try my hand at building a searcher bot during my winter break from school. I had an idea for an interesting sandwiching strategy (might write about it later), but since my bot would be using flashbots I’d have to find a way to win the flashbots auction while still maximizing profits. Sandwiching is a competitive field and so vying for the same sandwiching opportunity as countless other searchers would force me to give away profits to guarantee winning the auction. You walk away with less, but at least it’s something.</p>

<p>But what if there was a way to game the auctions so that you can secure a spot at the top of a block <em>without</em> giving away most of your profit? It’s like having your cake and eating it too, but the cake is money (loads of it). My attempt at doing so is what this post is about. Althought it didn’t work, I still think it wasn’t a terrible idea and I learned something new about geth in the end.</p>

<h2 id="some-background">Some Background</h2>

<p>For my searchers already familiar with flashbots, recall that bundles are sorted by effective gas price (<code class="language-plaintext highlighter-rouge">mevGasPrice</code> in mev-geth, i may also refer to it as “score”). Searchers aiming for the same opportunity in a block have to outbid other searchers for it, leaving barely any profit for themselves, since only one searcher can profit from the opportunity.</p>

<p>Recall some properties about flashbots bundles and the auction:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">mevGasPrice := [delta_coinbase + (gasUsed * gasPrice)] / gasUsed</code> where <code class="language-plaintext highlighter-rouge">delta_coinbase</code> is the amount directly sent to the miner’s coinbase address. (note: it’s a really a sum of <code class="language-plaintext highlighter-rouge">gasUsed * gasPrice</code> across all txs in a bundle, but this definition is simpler for what I want to show)</li>
  <li>if we don’t make any direct payments to the miner (i.e. <code class="language-plaintext highlighter-rouge">delta_coinbase = 0</code>) then <code class="language-plaintext highlighter-rouge">mevGasPrice = gasPrice</code>.</li>
  <li>if any tx in a bundle reverts then the bundle won’t land onchain <em>unless</em> the hash of the tx in question is included in the <code class="language-plaintext highlighter-rouge">revertingTxHashes</code> field of our bundle request.</li>
</ul>

<p>We can look at the effectice gas price as a measure of “profit per compute” for the miner, and so to maximize revenue for the miner flashbots prioritizes bundles that pay more per gas used. Making a direct payment to the miner requires additional gas and so it’s more economical to omit the direct payment and pay by upping the gas price on your swaps (or wtv txs your strat entails).</p>

<p>If we have to up the gas price on our txs to ensure we win the opportunity, then we need to lower our gas used in order to bank more profit. Hence why you’ve probably noticed your favourite 0xAnimeFemboy mev account on the tl shilling yul+. Writing the most gas efficient contract means you can safely up your gas price which means easy $$$.</p>

<p>I’m lazy and I only had about 2 weeks until I started school again, so I wasn’t about to become an optimizoooor. Instead, I was gonna try gaming the auction. Someone already gamed the auction before, where they <a href="https://twitter.com/bertcmiller/status/1407305924600029189">reduced their gas price after their bundle got merged</a>. I was gonna try using way less gas than flashbots would expect.</p>

<h2 id="the-strategy">The Strategy</h2>

<p>The strat entailed making use of this fun little fact about gas limits:</p>
<blockquote>
  <p>[I]f you put a gas limit of 50,000 for a simple ETH transfer, the EVM would consume 21,000, and you would get back the remaining 29,000. However, if you specify too little gas, for example, a gas limit of 20,000 for a simple ETH transfer, the EVM will consume your 20,000 gas units attempting to fulfill the transaction, but it will not complete. The EVM then reverts any changes, but since the miner has already done 20k gas units worth of work, that gas is consumed.</p>
</blockquote>

<p>from <a href="https://ethereum.org/en/developers/docs/gas/#what-is-gas-limit">ethereum.org</a></p>

<p>Note that the definition of the effective gas price didn’t require that any of our smart contract txs pay the bribe to the miner. Say we included an eth transfer in our bundle that handled our bribe, and that we set the gas limit to <code class="language-plaintext highlighter-rouge">1 gas</code> and the gas price to <code class="language-plaintext highlighter-rouge">100k gwei/gas</code>. We’d need to allow this tx to revert in our bundle (via <code class="language-plaintext highlighter-rouge">revertingTxHashes</code>) since any tx with a gas limit lower than 21k gas would revert. Our bundle could then land onchain, revert, and only consume 1 gas in doing so. This will only cost us <code class="language-plaintext highlighter-rouge">1 gas * 100k gwei/gas = 100k gwei</code> and our bundle’s score would be boosted by <code class="language-plaintext highlighter-rouge">100k</code> which guarantees us first priority in the auction by a large margin. We can then safely set the gas price on our swaps to whatever the <code class="language-plaintext highlighter-rouge">base_fee</code> was that block since we don’t wanna compete on gas price with high gas txs.</p>

<p>Those familiar with geth have probably noticed the flaw in this strategy by now and already know where this is going, but I won’t spoil the (unfortunate) surprise just yet.</p>

<h2 id="the-attempt">The Attempt</h2>

<p>Before my attempt, I needed to check if this would be possible in mev-geth. So I took a look at the <a href="https://github.com/flashbots/mev-geth/blob/master/miner/worker.go#L1414"><code class="language-plaintext highlighter-rouge">computeBundleGas</code></a> method, which is what returns our bundle’s score (<code class="language-plaintext highlighter-rouge">mevGasPrice</code>). These lines in particular were of interest.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">receipt</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">core</span><span class="o">.</span><span class="n">ApplyTransaction</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">chainConfig</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">.</span><span class="n">coinbase</span><span class="p">,</span> <span class="n">gasPool</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempGasUsed</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">GetVMConfig</span><span class="p">())</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">simulatedBundle</span><span class="p">{},</span> <span class="n">err</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">receipt</span><span class="o">.</span><span class="n">Status</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">ReceiptStatusFailed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsHash</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">RevertingTxHashes</span><span class="p">,</span> <span class="n">receipt</span><span class="o">.</span><span class="n">TxHash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">simulatedBundle</span><span class="p">{},</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"failed tx"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The first line applies the tx and returns a receipt and any errors encoutered. If the receipt showed the tx failed and reverted and wasn’t included in our bundle’s <code class="language-plaintext highlighter-rouge">revertingTxHashes</code> then we would throw an error and reject the bundle. But if we did include our tx in the <code class="language-plaintext highlighter-rouge">revertingTxHashes</code> then our method would proceed as normal and add our <code class="language-plaintext highlighter-rouge">gasUsed</code> and <code class="language-plaintext highlighter-rouge">gasPrice</code> to the tally, gaming the flashbots auction for the low. I thought the <code class="language-plaintext highlighter-rouge">err</code> variable was interesting but didn’t give it much thought at first. That proved to be a fatal mistake later on.</p>

<p>So I get to testing, submiting my bundles with this lil hack thinking it’s gonna go through. That’s when I get hit with an <code class="language-plaintext highlighter-rouge">intrinsic gas too low</code> error saying I need to supply 21k gas instead of just 1 gas. After some digging I found out this wasn’t a flashbots error but rather an <a href="https://github.com/ethereum/go-ethereum/blob/master/core/state_transition.go#L298">error that geth itself was throwing</a> (coming from <code class="language-plaintext highlighter-rouge">core.ApplyTransaction</code>). Turns out geth <em>won’t even broadcast</em> a tx destined to fail at all, which makes sense since that’s pointless compute being spent by the miner for no real reason. Unfortunately, my strategy depended on the fact that we were intentionally letting a tx land onchain so it would fail, and geth completely foiled those plans.</p>

<hr />

<p>Like I said in the beginning, this wasn’t my worst idea ever. I just wasn’t expecting geth to intervene like that when I saw on ethereum’s website that any gas under 21k is consumed whether the tx reverts or not. I later realized that that was describing the EVM’s behaviour, not the client’s (geth) which was free to implement any checks beforehand. Unfortunate.</p>

<p>Edit: Apparently this is standard client behaviour as described in section 6 of the <a href="https://ethereum.github.io/yellowpaper/paper.pdf">yellowpaper</a> and not unique to geth (s/o to the homie <a href="https://twitter.com/0xalpharush">@0xalpharush</a> for pointing this out). But that was in the Berlin version of the yellowpaper, so now I’m still not sure if the official site was completely wrong or just outdated. That’s on me though, I should’ve just read the code for myself first instead of going off the website.</p>

<p>I’m still not interested in being an optimizooor despite not being able to game the auction, and I learned just how involved building a competitive searcher bot is over my winter break. It’s definitely not something I can slap together in 2 weeks like I originally planned. I’ll see how I end up going about this mev shit but I’ll have to take my time with it if I wanna be competitive.</p>

<p>Thank you for reading, and see you in the mempool :)</p>

  </div><a class="u-url" href="/blog/mev/2022/01/08/gaming-fb-auction.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>welcome to my blog!</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ghiliweld" target="_blank" title="ghiliweld"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ghiliweld" target="_blank" title="ghiliweld"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
